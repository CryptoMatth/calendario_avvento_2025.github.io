<!DOCTYPE html>

<html lang="it">

	<head>
		<meta charset="UTF-8" />
		<meta name="viewport" content="width=device-width, initial-scale=1.0" /> <!-- assicura che il sito sia responsivo e si adatti alla larghezza dello schermo del dispositivo. -->
		<title>Calendario dell'Avvento - Costellazioni</title>
		<script src="https://cdn.tailwindcss.com"></script> <!-- imposta il titolo della pagina che appare nella scheda del browser -->
		
		<style> <!-- definisce un set di variabili CSS per colori base, semplificando la gestione dei colori in tutto il sito -->
		  :root {
			/* Primitive Color Tokens */
			--color-white: rgba(255, 255, 255, 1);
			--color-black: rgba(0, 0, 0, 1);
			--color-cream-50: rgba(252, 252, 249, 1);
			--color-cream-100: rgba(255, 255, 253, 1);
			--color-gray-200: rgba(245, 245, 245, 1);
			--color-gray-300: rgba(167, 169, 169, 1);
			--color-gray-400: rgba(119, 124, 124, 1);
			--color-slate-500: rgba(98, 108, 114, 1);
			
			/* Semantic Color Tokens */
			--color-primary-50: rgba(235, 249, 255, 1);
			--color-primary-100: rgba(199, 237, 255, 1);
			--color-primary-400: rgba(64, 150, 206, 1);
			--color-primary-500: rgba(20, 110, 167, 1);
			--color-primary-600: rgba(8, 77, 131, 1);
			--color-primary-800: rgba(5, 50, 85, 1);
			--color-secondary-300: rgba(255, 219, 108, 1);
			--color-secondary-500: rgba(255, 179, 0, 1);
			--color-error-500: rgba(220, 38, 38, 1);
			--color-success-500: rgba(16, 185, 129, 1);
			
			/* Special Advent Colors */
			--color-star: #FFD700; /* Oro */
			--color-space-bg: #0A0A1F; /* Blu scuro spaziale */
			--color-door-unopened: #1A374D; /* Blu notte per porta chiusa */
			--color-door-hover: #3D5A80;
			--color-door-opened: #0077B6; /* Blu pi√π chiaro per porta aperta */
			--color-glow: rgba(255, 255, 255, 0.5); /* Effetto bagliore */
		  }
		  
		  body {
			font-family: 'Inter', sans-serif;
			background-color: var(--color-space-bg);
			color: var(--color-white);
		  }
		  
		  .advent-grid {
			display: grid;
			grid-template-columns: repeat(auto-fit, minmax(100px, 1fr));
			gap: 16px;
			padding: 24px;
		  }
		  
		  .star-bg {
			background-image: radial-gradient(circle at center, rgba(255, 255, 255, 0.1) 1px, transparent 1px);
			background-size: 50px 50px;
		  }
		  
		  .quiz-modal-bg {
			backdrop-filter: blur(5px);
			background-color: rgba(10, 10, 31, 0.8);
		  }
		  
		  @keyframes pulse-glow {
			0%, 100% { box-shadow: 0 0 5px var(--color-star), 0 0 10px var(--color-star); }
			50% { box-shadow: 0 0 10px var(--color-star), 0 0 20px var(--color-star); }
		  }
		  
		  .glowing-button {
			animation: pulse-glow 2s infinite ease-in-out;
		  }

          /* Stile per il toast */
		  #toast-container {
			position: fixed;
			top: 20px;
			right: 20px;
			z-index: 1000;
		  }
		  .toast {
			padding: 12px 20px;
			margin-bottom: 10px;
			border-radius: 8px;
			box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
			opacity: 0;
			transition: opacity 0.5s, transform 0.5s;
			transform: translateX(100%);
		  }
		  .toast.show {
			opacity: 1;
			transform: translateX(0);
		  }
		  .toast-success { background-color: var(--color-success-500); color: var(--color-white); }
		  .toast-error { background-color: var(--color-error-500); color: var(--color-white); }

		</style>
		
		<!-- Importazioni Firebase CDN per un'applicazione React a file singolo -->
		<script type="module">
			import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
			import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
			import { getFirestore, doc, getDoc, setDoc, onSnapshot, collection, query, limit, orderBy } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
			import { setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

			// Imposta il livello di log per Firestore (utile per il debugging)
			setLogLevel('debug');
			
			window.firebase = {
				initializeApp,
				getAuth,
				signInAnonymously,
				signInWithCustomToken,
				onAuthStateChanged,
				getFirestore,
				doc,
				getDoc,
				setDoc,
				onSnapshot,
				collection,
				query,
				limit,
				orderBy
			};
		</script>
	</head>
	
	<body>
		<div id="toast-container"></div>
		<div id="app" class="min-h-screen star-bg">
			<!-- L'app React verr√† montata qui -->
		</div>

		<!-- Script React -->
		<script src="https://unpkg.com/react@18/umd/react.development.js"></script>
		<script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
		<script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
		
		<script type="text/babel">
			const { useState, useEffect, useCallback, useMemo, createContext, useContext } = React;
			
			// Variabili globali fornite dall'ambiente (Devono essere sempre definite)
			const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
			const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};
			const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

			// --- Funzioni di Utilit√† Globali ---
			
			// Mostra un messaggio toast
			function showToast(message, type = 'info') {
				const toastContainer = document.getElementById('toast-container');
				if (!toastContainer) return;

				const toast = document.createElement('div');
				toast.className = `toast toast-${type} z-50`;
				toast.textContent = message;

				toastContainer.appendChild(toast);

				// Mostra e nascondi
				setTimeout(() => {
					toast.classList.add('show');
				}, 50);

				setTimeout(() => {
					toast.classList.remove('show');
					setTimeout(() => {
						toastContainer.removeChild(toast);
					}, 500); // Rimuovi dopo la transizione di fade-out
				}, 5000);
			}

			// Ottiene la data corrente di Advent (semplificata a novembre/dicembre)
			const getAdventDay = () => {
				const now = new Date();
				const month = now.getMonth();
				const day = now.getDate();

				// Calendario dell'Avvento va dal 1 al 24 dicembre
				if (month === 11 && day >= 1 && day <= 24) {
					return day;
				}
				
				// Per i test, se √® novembre, usiamo i giorni da 1 a 24 come fittizi
				if (month === 10 && day >= 1 && day <= 24) {
					// Mappa novembre a giorni fittizi di dicembre
					return day; 
				}

				return 0; // Fuori dal periodo di Advent
			};
			
			const TOTAL_ADVENT_DAYS = 24;
			
			// --- Contesto Firebase ---
			const FirebaseContext = createContext(null);

			const useFirebase = () => {
				return useContext(FirebaseContext);
			};

			// --- Componente per la gestione dello Stato Firebase ---
			const FirebaseProvider = ({ children }) => {
				const [db, setDb] = useState(null);
				const [auth, setAuth] = useState(null);
				const [userId, setUserId] = useState(null);
				const [isDbReady, setIsDbReady] = useState(false);

				useEffect(() => {
					const initializeFirebase = async () => {
						try {
							console.log("‚öôÔ∏è Tentativo di inizializzazione Firebase...");
							if (!window.firebase) {
								console.error("Firebase SDK non caricato correttamente.");
								showToast("Errore: Firebase SDK mancante.", 'error');
								return;
							}
							
							const app = window.firebase.initializeApp(firebaseConfig);
							const firestore = window.firebase.getFirestore(app);
							const authService = window.firebase.getAuth(app);

							setDb(firestore);
							setAuth(authService);
							
							// Gestione dell'autenticazione
							const unsubscribe = window.firebase.onAuthStateChanged(authService, async (user) => {
								if (user) {
									setUserId(user.uid);
									console.log("‚úÖ Utente autenticato. UID:", user.uid);
									setIsDbReady(true);
								} else {
									try {
										if (initialAuthToken) {
											await window.firebase.signInWithCustomToken(authService, initialAuthToken);
										} else {
											// Fallback: Autenticazione anonima se il token non √® disponibile (per i test)
											const anonymousUser = await window.firebase.signInAnonymously(authService);
											setUserId(anonymousUser.user.uid);
											console.log("‚ö†Ô∏è Accesso anonimo. UID:", anonymousUser.user.uid);
											setIsDbReady(true);
										}
									} catch (error) {
										console.error("‚ùå Errore durante l'autenticazione:", error);
										showToast("Errore di autenticazione: " + error.message, 'error');
										setUserId(crypto.randomUUID()); // ID fittizio in caso di fallimento
										setIsDbReady(true);
									}
								}
							});
							
							// Cleanup function
							return () => unsubscribe();

						} catch (error) {
							console.error("‚ùå Errore durante l'inizializzazione o l'autenticazione di Firebase:", error);
							showToast("Errore critico di Firebase: Controlla la console.", 'error');
							setUserId(crypto.randomUUID());
							setIsDbReady(true);
						}
					};

					initializeFirebase();
				}, []); // Esegui solo al mount

				const contextValue = { db, auth, userId, isDbReady };

				return (
					<FirebaseContext.Provider value={contextValue}>
						{children}
					</FirebaseContext.Provider>
				);
			};

			// --- Componente CalendarDay ---
			
			const CalendarDay = ({ day, currentDay, onOpenDoor, progress, setProgress, onCompleteQuiz }) => {
				const { db, userId, isDbReady } = useFirebase();
				const isDayOpen = progress[day] && progress[day].opened;
				const isQuizPassed = progress[day] && progress[day].quizPassed;
				const isAvailable = day <= currentDay;
				const isToday = day === currentDay;
				
				const [showQuiz, setShowQuiz] = useState(false);
				const [showFeedback, setShowFeedback] = useState(null); // 'correct' or 'incorrect'
				const [dayProgress, setDayProgress] = useState(null); // Stato locale per il progresso
				
				const dayId = day.toString().padStart(2, '0');
				const collectionPath = `artifacts/${appId}/users/${userId}/advent_progress`;
				const docPath = window.firebase.doc(db, collectionPath, dayId);

				// Funzione per caricare il progresso del giorno specifico
				const loadDayProgress = useCallback(async () => {
					if (!isDbReady || !db || !userId) return;

					try {
						const docSnap = await window.firebase.getDoc(docPath);
						if (docSnap.exists()) {
							const data = docSnap.data();
							setDayProgress(data);
							
							// Sincronizza lo stato globale con il dato locale
							setProgress(prev => ({
								...prev,
								[day]: {
									opened: data.opened || false,
									quizPassed: data.quizPassed || false
								}
							}));
						}
					} catch (error) {
						console.error(`‚ùå Errore caricamento progresso giorno ${day}:`, error);
						// Gestione errore o fallback a stato predefinito
					}
				}, [isDbReady, db, userId, day, docPath, setProgress]);


				// Ascolta i cambiamenti di stato in tempo reale (Lifecycle/Firestore)
				useEffect(() => {
					// FIX: Esegui solo se db e userId sono pronti
					if (!isDbReady || !db || !userId) {
						console.log(`üü° Day ${day}: Inizializzazione Firebase non pronta. Salto l'ascolto.`);
						return; 
					}
					
					console.log(`üëÇ Day ${day}: Avvio ascolto in tempo reale per ${dayId}`);

					const unsubscribe = window.firebase.onSnapshot(docPath, (docSnap) => {
						if (docSnap.exists()) {
							const data = docSnap.data();
							setDayProgress(data);
							
							// Aggiorna lo stato globale
							setProgress(prev => ({
								...prev,
								[day]: {
									opened: data.opened || false,
									quizPassed: data.quizPassed || false
								}
							}));
						} else {
							// Se il documento non esiste, impostalo come non aperto
							setDayProgress({ opened: false, quizPassed: false });
						}
					}, (error) => {
						console.error(`‚ùå Errore onSnapshot per il giorno ${day}:`, error);
						showToast(`Errore sincronizzazione giorno ${day}`, 'error');
					});

					// Pulizia dell'abbonamento
					return () => unsubscribe();
				}, [isDbReady, db, userId, day, docPath, setProgress]); // Dipendenze chiare

				const handleDoorClick = async () => {
					if (!isAvailable) {
						showToast(`Devi aspettare il giorno ${day}!`, 'info');
						return;
					}
					
					if (!isDbReady || !db || !userId) {
						showToast("Database non pronto, riprova tra poco.", 'error');
						return;
					}

					if (!isDayOpen) {
						// Apertura della porta
						try {
							const newData = { opened: true, quizPassed: false };
							await window.firebase.setDoc(docPath, newData, { merge: true });
							onOpenDoor(day); // Notifica l'apertura all'App principale
							showToast(`Hai aperto la porta del giorno ${day}!`, 'success');
							setShowQuiz(true); // Mostra il quiz subito dopo l'apertura
						} catch (error) {
							console.error(`‚ùå Errore apertura porta giorno ${day}:`, error);
							showToast(`Errore: impossibile aprire la porta del giorno ${day}.`, 'error');
						}
					} else if (isDayOpen && !isQuizPassed) {
						// La porta √® aperta ma il quiz non √® stato completato
						setShowQuiz(true);
					}
					// Se il quiz √® superato, non succede nulla o si mostra la costellazione
				};

				const handleQuizCompletion = async (isCorrect) => {
					if (!isDbReady || !db || !userId) {
						showToast("Database non pronto, impossibile salvare il quiz.", 'error');
						return;
					}
					
					setShowQuiz(false);
					setShowFeedback(isCorrect ? 'correct' : 'incorrect');
					
					if (isCorrect) {
						try {
							const newData = { quizPassed: true, score: 1 };
							await window.firebase.setDoc(docPath, newData, { merge: true });
							onCompleteQuiz(day);
						} catch (error) {
							console.error(`‚ùå Errore salvataggio quiz giorno ${day}:`, error);
							showToast(`Errore: impossibile salvare il risultato del quiz.`, 'error');
						}
					}
					
					setTimeout(() => setShowFeedback(null), 3000);
				};
				
				// Stili dinamici
				let doorClass = 'bg-primary-600 hover:bg-door-hover';
				let content = day;
				let icon = '‚ú®';

				if (isAvailable && !isDayOpen) {
					// Porta disponibile ma chiusa
					doorClass = 'bg-door-unopened hover:bg-door-hover cursor-pointer shadow-xl transition duration-300';
					if (isToday) {
						doorClass += ' glowing-button border-4 border-star';
						icon = 'üéÅ';
					}
				} else if (isDayOpen) {
					// Porta aperta
					doorClass = 'bg-door-opened cursor-default shadow-lg border-2 border-star';
					content = isQuizPassed ? '‚úÖ' : '‚ùì'; // Metti un simbolo di costellazione (o quiz in attesa)
					icon = 'üåå';
					if (isQuizPassed) {
						icon = 'üèÜ';
					}
				} else {
					// Porta non disponibile
					doorClass = 'bg-slate-500 cursor-not-allowed border-2 border-gray-400 opacity-60';
					icon = 'üîí';
				}

				return (
					<div className="relative aspect-square">
						<div
							className={`w-full h-full flex flex-col items-center justify-center p-2 rounded-xl text-center ${doorClass}`}
							onClick={isAvailable ? handleDoorClick : null}
						>
							<div className="text-4xl mb-1">{icon}</div>
							<div className="text-2xl font-bold">{day}</div>
						</div>
						
						{showQuiz && (
							<QuizModal
								day={day}
								onClose={() => setShowQuiz(false)}
								onQuizCompletion={handleQuizCompletion}
							/>
						)}
						
						{/* Feedback sul Quiz */}
						{showFeedback && (
							<div 
								className={`absolute inset-0 z-20 flex items-center justify-center rounded-xl transition-opacity duration-300 ${showFeedback === 'correct' ? 'bg-success-500/90' : 'bg-error-500/90'}`}
								style={{ pointerEvents: 'none' }}
							>
								<div className="text-4xl font-extrabold text-white">
									{showFeedback === 'correct' ? 'Corretto! +1 Punto' : 'Riprova!'}
								</div>
							</div>
						)}
						
						{/* Dettagli della costellazione dopo il superamento del quiz */}
						{(isDayOpen && isQuizPassed && !showQuiz) && (
							<div className="absolute inset-0 z-10 flex flex-col items-center justify-center bg-space-bg/80 p-2 rounded-xl text-center border-2 border-star">
								<div className="text-3xl">üî≠</div>
								<div className="text-xs font-semibold mt-1">Costellazione del Giorno</div>
							</div>
						)}
					</div>
				);
			};

			// --- Componente QuizModal ---
			
			// Mock di domande del quiz (da 1 a 24)
			const MOCK_QUIZ_QUESTIONS = {};
			for (let i = 1; i <= TOTAL_ADVENT_DAYS; i++) {
				MOCK_QUIZ_QUESTIONS[i] = {
					question: `Qual √® il nome della costellazione associata al giorno ${i} dell'Avvento? (Mock)`,
					options: ['Orione', 'Cassiopea', 'Orsa Maggiore', 'Sconosciuta'],
					correctAnswer: 'Sconosciuta' // Risposta mock
				};
			}

			const QuizModal = ({ day, onClose, onQuizCompletion }) => {
				const quizData = MOCK_QUIZ_QUESTIONS[day] || { question: "Nessun quiz trovato.", options: [], correctAnswer: null };
				const [selectedOption, setSelectedOption] = useState(null);
				const [isSubmitting, setIsSubmitting] = useState(false);

				const handleSubmit = () => {
					setIsSubmitting(true);
					setTimeout(() => {
						const isCorrect = selectedOption === quizData.correctAnswer;
						onQuizCompletion(isCorrect);
						setIsSubmitting(false);
					}, 1000); // Simulazione di ritardo di rete
				};
				
				return (
					<div className="fixed inset-0 z-50 flex items-center justify-center quiz-modal-bg p-4">
						<div className="bg-primary-800 p-6 rounded-2xl w-full max-w-lg shadow-2xl border border-primary-500">
							<h3 className="text-2xl font-bold text-star mb-4">Quiz del Giorno {day}</h3>
							<p className="mb-6 text-cream-100">{quizData.question}</p>
							
							<div className="space-y-3 mb-6">
								{quizData.options.map((option, index) => (
									<button
										key={index}
										className={`w-full text-left p-3 rounded-lg transition-all duration-200 border-2 ${
											selectedOption === option
												? 'bg-secondary-500 text-black border-secondary-300 shadow-md'
												: 'bg-primary-600 text-white border-primary-500 hover:bg-primary-500'
										}`}
										onClick={() => setSelectedOption(option)}
										disabled={isSubmitting}
									>
										{option}
									</button>
								))}
							</div>
							
							<div className="flex justify-end space-x-3">
								<button
									className="px-4 py-2 bg-gray-400 text-primary-800 rounded-lg font-semibold hover:bg-gray-300 transition duration-200"
									onClick={onClose}
									disabled={isSubmitting}
								>
									Annulla
								</button>
								<button
									className={`px-6 py-2 rounded-lg font-bold transition duration-200 ${
										selectedOption && !isSubmitting
											? 'bg-star text-primary-800 hover:bg-white'
											: 'bg-gray-500 text-gray-300 cursor-not-allowed'
									}`}
									onClick={handleSubmit}
									disabled={!selectedOption || isSubmitting}
								>
									{isSubmitting ? 'Invio...' : 'Invia Risposta'}
								</button>
							</div>
						</div>
					</div>
				);
			};

			// --- Componente Leaderboard ---
			const Leaderboard = ({ isOpen, onClose }) => {
				const { db, isDbReady } = useFirebase();
				const [leaderboard, setLeaderboard] = useState([]);
				const [isLoading, setIsLoading] = useState(true);

				const loadLeaderboard = useCallback(async () => {
					// FIX: Controlla se il DB √® pronto
					if (!isDbReady || !db) {
						console.log("üü° Leaderboard: Database non pronto. Ritorno.");
						return; 
					}
					
					setIsLoading(true);
					try {
						const collectionPath = `artifacts/${appId}/public/data/advent_leaderboard`;
						// FIX: Uso delle funzioni Firestore importate tramite window.firebase
						const q = window.firebase.query(
							window.firebase.collection(db, collectionPath),
							window.firebase.orderBy('totalScore', 'desc'),
							window.firebase.limit(10)
						);
						
						// Usa onSnapshot per l'aggiornamento in tempo reale
						const unsubscribe = window.firebase.onSnapshot(q, (querySnapshot) => {
							const entries = [];
							querySnapshot.forEach((doc) => {
								entries.push({ id: doc.id, ...doc.data() });
							});
							
							// FIX: Ordinamento lato client per evitare errori di indice se necessario, ma qui Firestore query √® usato
							setLeaderboard(entries);
							setIsLoading(false);
						}, (error) => {
							console.error('‚ùå Errore caricamento classifica:', error);
							showToast('Errore caricamento classifica', 'error');
							setIsLoading(false);
						});
						
						return () => unsubscribe();

					} catch (error) {
						console.error('‚ùå Errore caricamento classifica:', error);
						showToast('Errore caricamento classifica', 'error');
						setIsLoading(false);
					}
				}, [isDbReady, db]);

				useEffect(() => {
					if (isOpen && isDbReady) {
						return loadLeaderboard();
					}
				}, [isOpen, isDbReady, loadLeaderboard]);
				
				if (!isOpen) return null;

				return (
					<div className="fixed inset-0 z-50 flex items-center justify-center quiz-modal-bg p-4">
						<div className="bg-primary-800 p-6 rounded-2xl w-full max-w-lg shadow-2xl border border-star h-4/5 overflow-y-auto">
							<h3 className="text-3xl font-extrabold text-star text-center mb-6">
								Classifica Esploratori Stellari üèÜ
							</h3>
							
							{isLoading && (
								<div className="text-center py-8">Caricamento classifica...</div>
							)}
							
							{!isLoading && leaderboard.length === 0 && (
								<div className="text-center py-8 text-gray-300">Nessun punteggio ancora! Sii il primo.</div>
							)}

							{!isLoading && leaderboard.length > 0 && (
								<table className="w-full text-left table-auto">
									<thead>
										<tr className="border-b border-primary-500 text-secondary-300">
											<th className="py-2">Pos.</th>
											<th className="py-2">Esploratore (ID Utente)</th>
											<th className="py-2 text-right">Punteggio</th>
										</tr>
									</thead>
									<tbody>
										{leaderboard.map((entry, index) => (
											<tr key={entry.id} className={`border-b border-primary-600 ${index % 2 === 0 ? 'bg-primary-700' : 'bg-primary-800'}`}>
												<td className="py-3 font-bold text-lg">{index + 1}</td>
												<td className="py-3 truncate max-w-xs">{entry.id}</td>
												<td className="py-3 text-right font-extrabold text-star">{entry.totalScore}</td>
											</tr>
										))}
									</tbody>
								</table>
							)}
							
							<div className="mt-6 flex justify-center">
								<button
									className="px-6 py-2 bg-primary-600 text-white rounded-lg font-semibold hover:bg-primary-500 transition duration-200 border-2 border-primary-500"
									onClick={onClose}
								>
									Chiudi Classifica
								</button>
							</div>
						</div>
					</div>
				);
			};

			// --- Componente App Principale ---
			const App = () => {
				const [progress, setProgress] = useState({});
				const currentDay = getAdventDay();
				const [currentPage, setCurrentPage] = useState('calendar'); // 'calendar', 'quiz', 'leaderboard'
				const [currentQuizDay, setCurrentQuizDay] = useState(null);
				const [isLeaderboardOpen, setIsLeaderboardOpen] = useState(false);
				const { db, userId, isDbReady } = useFirebase(); // Usa il contesto

				const totalScore = useMemo(() => {
					return Object.values(progress).filter(day => day.quizPassed).length;
				}, [progress]);

				// Aggiornamento del punteggio pubblico nella Leaderboard
				const updateLeaderboardScore = useCallback(async (score) => {
					// FIX: Esegui solo se db e userId sono pronti
					if (!isDbReady || !db || !userId) return;

					try {
						const collectionPath = `artifacts/${appId}/public/data/advent_leaderboard`;
						const docPath = window.firebase.doc(db, collectionPath, userId);
						
						const newScore = score || totalScore;

						await window.firebase.setDoc(docPath, { 
							totalScore: newScore,
							lastUpdate: window.firebase.serverTimestamp ? window.firebase.serverTimestamp() : new Date(),
							// L'ID utente √® gi√† il doc id, non serve salvarlo come campo a meno che non sia necessario per l'ordinamento
						}, { merge: true });
						
						console.log(`üöÄ Classifica aggiornata per l'utente ${userId} con punteggio ${newScore}`);
					} catch (error) {
						console.error("‚ùå Errore aggiornamento classifica:", error);
						showToast("Errore aggiornamento classifica", 'error');
					}
				}, [isDbReady, db, userId, totalScore]);


				// Effetto per sincronizzare lo score totale quando il progresso cambia
				useEffect(() => {
					if (isDbReady && userId) {
						updateLeaderboardScore(totalScore);
					}
				}, [totalScore, isDbReady, userId, updateLeaderboardScore]);

				// Funzioni di callback
				const handleOpenDoor = (day) => {
					// L'aggiornamento dello stato avviene in CalendarDay e tramite onSnapshot
					// qui possiamo solo innescare la visualizzazione del quiz se necessario
					setCurrentQuizDay(day);
				};

				const handleCompleteQuiz = (day) => {
					// L'aggiornamento del punteggio totale avviene tramite l'useEffect
					showToast("Quiz superato! Punti aggiunti alla classifica.", 'success');
				};

				const renderCalendar = () => (
					<div className="advent-grid">
						{Array.from({ length: TOTAL_ADVENT_DAYS }, (_, i) => i + 1).map(day => (
							<CalendarDay
								key={day}
								day={day}
								currentDay={currentDay}
								onOpenDoor={handleOpenDoor}
								progress={progress}
								setProgress={setProgress}
								onCompleteQuiz={handleCompleteQuiz}
							/>
						))}
					</div>
				);

				const renderContent = () => {
					if (!isDbReady) {
						return (
							<div className="text-center pt-20">
								<div className="text-xl text-star animate-pulse">üåå Connessione con le stelle...</div>
								<p className="mt-4 text-gray-300">Inizializzazione del sistema di autenticazione e database.</p>
							</div>
						);
					}

					return (
						<>
							<div className="flex justify-center p-4 space-x-4">
								<button 
									onClick={() => setIsLeaderboardOpen(true)}
									className="px-6 py-2 bg-star text-primary-800 font-bold rounded-full shadow-lg hover:shadow-xl transition duration-300"
								>
									üèÜ Classifica ({totalScore})
								</button>
								<div className="px-4 py-2 bg-primary-600 text-white rounded-full flex items-center shadow-lg">
									<span className="font-semibold mr-2">Utente ID:</span> 
									<span className="text-sm font-mono truncate max-w-[200px] sm:max-w-none">{userId || 'Anonimo'}</span>
								</div>
							</div>
							
							<div className="max-w-5xl mx-auto">
								{renderCalendar()}
							</div>
							
							<Leaderboard isOpen={isLeaderboardOpen} onClose={() => setIsLeaderboardOpen(false)} />
						</>
					);
				};
				
				return (
					<div className="container mx-auto p-4">
						<header className="text-center py-8">
							<h1 className="text-5xl font-extrabold text-star leading-tight shadow-text-md">
								Calendario dell'Avvento 2025: Esploratori Stellari
							</h1>
							<p className="text-xl text-primary-100 mt-2">Apri la finestra del giorno {currentDay} per scoprire la costellazione!</p>
						</header>
						
						<main>
							{renderContent()}
						</main>
					</div>
				);
			};

			// --- Componente Root dell'Applicazione ---
			const Root = () => (
				<FirebaseProvider>
					<App />
				</FirebaseProvider>
			);

			// Inizializzazione DOM e rendering di React
			document.addEventListener('DOMContentLoaded', function() {
				console.log('üöÄ DOM caricato, avvio calendario React...');
				
				try {
					const container = document.getElementById('app');
					if (container) {
						const root = ReactDOM.createRoot(container);
						root.render(React.createElement(Root));
						console.log('‚úÖ App calendario inizializzata con successo');
						
						setTimeout(() => {
							showToast('üéÑ Calendario dell\'Avvento caricato! Buon divertimento!', 'success');
						}, 1000);
					}
				} catch (error) {
					console.error('‚ùå Errore durante il rendering di React:', error);
					showToast('Errore critico di rendering.', 'error');
				}
			});
			
		</script>
	</body>
</html>
