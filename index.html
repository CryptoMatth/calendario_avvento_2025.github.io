<!DOCTYPE html>

<html lang="it">

	<head>
		<meta charset="UTF-8" />
		<meta name="viewport" content="width=device-width, initial-scale=1.0" /> <!-- assicura che il sito sia responsivo e si adatti alla larghezza dello schermo del dispositivo. -->
		<title>Calendario dell'Avvento - Costellazioni</title>
		<script src="https://cdn.tailwindcss.com"></script> <!-- imposta il titolo della pagina che appare nella scheda del browser -->
		
		<style> <!-- definisce un set di variabili CSS per colori base, semplificando la gestione dei colori in tutto il sito -->
		  :root {
			/* Primitive Color Tokens */
			--color-white: rgba(255, 255, 255, 1);
			--color-black: rgba(0, 0, 0, 1);
			--color-cream-50: rgba(252, 252, 249, 1);
			--color-cream-100: rgba(255, 255, 253, 1);
			--color-gray-200: rgba(245, 245, 245, 1);
			--color-gray-300: rgba(167, 169, 169, 1);
			--color-gray-400: rgba(119, 124, 124, 1);
			--color-slate-500: rgba(98, 108, 108, 1);
			--color-slate-600: rgba(69, 78, 78, 1);
			--color-slate-700: rgba(45, 52, 52, 1);
			--color-slate-800: rgba(29, 34, 34, 1);
			--color-slate-900: rgba(10, 15, 15, 1);
			--color-green-400: rgba(100, 191, 142, 1);
			--color-red-400: rgba(220, 84, 84, 1);
			--color-blue-400: rgba(119, 185, 255, 1);
			--color-gold-400: rgba(255, 182, 45, 1);
			--color-yellow-400: rgba(255, 220, 84, 1);
			--color-purple-400: rgba(180, 140, 255, 1);
			
			/* Semantic Tokens */
			--color-background-app: var(--color-cream-100);
			--color-text-primary: var(--color-slate-900);
			--color-text-secondary: var(--color-slate-600);
			--color-surface-default: var(--color-white);
			--color-surface-hover: var(--color-gray-200);
			--color-accent-primary: var(--color-green-400);
			--color-status-success: var(--color-green-400);
			--color-status-error: var(--color-red-400);
			--color-highlight: var(--color-gold-400);
		  }
		  
		  /* Aggiunge il font Inter (scelto per l'estetica) e lo applica a tutto il body */
		  @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap');
		  
		  body {
			font-family: 'Inter', sans-serif;
			background-color: var(--color-background-app);
			color: var(--color-text-primary);
			transition: background-color 0.3s ease;
		  }
		  
		  /* Stili aggiuntivi per le transizioni e animazioni */
		  .card-animation {
			transition: transform 0.3s ease, box-shadow 0.3s ease;
		  }
		  
		  .card-animation:hover {
			transform: translateY(-4px);
			box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
		  }
		  
		  .quiz-section-style {
			background-color: var(--color-surface-default);
			border: 2px solid var(--color-accent-primary);
			box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -2px rgba(0, 0, 0, 0.06);
		  }
		  
		  .quiz-card {
			background-color: var(--color-cream-50);
			border: 1px solid var(--color-gray-200);
		  }
		  
		  .modal-overlay {
			background-color: rgba(0, 0, 0, 0.6);
		  }
		  
		  /* Assicura che la griglia sia centrata verticalmente e orizzontalmente in dispositivi molto piccoli */
		  @media (max-width: 640px) {
			.grid-cols-5 {
			  grid-template-columns: repeat(3, minmax(0, 1fr));
			}
		  }
		</style>
		
		<!-- Carica le librerie Firebase -->
		<script type="module">
		  import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
		  import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
		  import { getFirestore, doc, setDoc, updateDoc, onSnapshot, collection, query, getDocs, runTransaction, arrayUnion } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
		  
		  // Variabili globali fornite dall'ambiente Canvas
		  const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
		  const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : null;
		  const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
		  
		  let app, db, auth;
		  
		  if (firebaseConfig) {
			try {
			  app = initializeApp(firebaseConfig);
			  db = getFirestore(app);
			  auth = getAuth(app);
			  
			  // Inietta le istanze nel window per l'accesso da React
			  window.db = db;
			  window.auth = auth;
			  
			  // Autenticazione: usa il token custom se disponibile, altrimenti anonima
			  onAuthStateChanged(auth, async (user) => {
				if (!user) {
				  try {
					if (initialAuthToken) {
					  await signInWithCustomToken(auth, initialAuthToken);
					  console.log('üîë Accesso eseguito con token custom.');
					} else {
					  await signInAnonymously(auth);
					  console.log('üë§ Accesso anonimo eseguito.');
					}
				  } catch (error) {
					console.error('‚ùå Errore autenticazione:', error);
				  }
				} else {
				  console.log('‚úÖ Utente autenticato (UID):', user.uid);
				}
			  });
			  
			} catch (error) {
			  console.error('‚ùå Errore inizializzazione Firebase:', error);
			}
		  } else {
			console.error('‚ùå Configurazione Firebase non trovata.');
		  }
		</script>
		
		<!-- Carica React e ReactDOM -->
		<script src="https://unpkg.com/react@18/umd/react.development.js"></script>
		<script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
		<!-- Carica Babel per la compilazione JSX -->
		<script src="https://unpkg.com/babel-standalone@6/babel.min.js"></script>
		
	</head>
	
	<body>
		<div id="mainApp" style="display: none;">
			<div id="app">
				<!-- L'applicazione React verr√† renderizzata qui -->
			</div>
		</div>
		
		<div id="toast-container" class="fixed top-4 right-4 z-50 space-y-2">
			<!-- I toast appariranno qui -->
		</div>
		
		<script>
		  // Funzioni di utilit√† JavaScript (Globali per essere usate ovunque)
		  
		  // Variabili globali per l'App ID (usate per i percorsi Firestore)
		  const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
		  
		  // Funzione per mostrare i toast
		  function showToast(message, type = 'info') {
			const container = document.getElementById('toast-container');
			if (!container) return;
			
			const toast = document.createElement('div');
			let bgColor, icon;
			
			if (type === 'success') {
			  bgColor = 'bg-green-500';
			  icon = `<svg class="w-6 h-6 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>`;
			} else if (type === 'error') {
			  bgColor = 'bg-red-500';
			  icon = `<svg class="w-6 h-6 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 14l2-2m0 0l2-2m-2 2l-2-2m2 2l2 2m7-2a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>`;
			} else {
			  bgColor = 'bg-blue-500';
			  icon = `<svg class="w-6 h-6 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>`;
			}
			
			toast.className = `flex items-center ${bgColor} text-white text-sm font-bold px-4 py-3 rounded-lg shadow-lg transition-opacity duration-300 opacity-0`;
			toast.innerHTML = `${icon}<p>${message}</p>`;
			
			container.appendChild(toast);
			
			// Animazione di comparsa
			setTimeout(() => {
			  toast.classList.remove('opacity-0');
			}, 10);
			
			// Animazione di scomparsa e rimozione
			setTimeout(() => {
			  toast.classList.add('opacity-0');
			  toast.addEventListener('transitionend', () => toast.remove());
			}, 4000);
		  }
		  
		  // Funzione fittizia per il caricamento del progresso (Firestore gestir√† quello reale)
		  function loadProgress() {
			try {
			  const progressJson = localStorage.getItem('adventCalendarProgress');
			  return progressJson ? JSON.parse(progressJson) : {};
			} catch (e) {
			  console.error("Errore caricamento progresso da localStorage (uso fall-back):", e);
			  return {};
			}
		  }
		  
		  // Inizializzazione semplificata
		  function initializeApp() {
			console.log('üöÄ Inizializzando Calendario dell\'Avvento semplificato...');
			
			// Carica progresso dalla memoria se presente
			const progress = loadProgress();
			if (Object.keys(progress).length > 0) {
			  console.log('üíæ Progressi trovati in memoria JavaScript:', Object.keys(progress).length, 'giorni');
			}
		  }
		  
		  // Inizializzazione DOM semplificata
		  document.addEventListener('DOMContentLoaded', function() {
			console.log('üöÄ DOM caricato, avvio calendario semplificato...');
			
			initializeApp();
			
			// Nascondi elementi non necessari e mostra app
			const mainApp = document.getElementById('mainApp');
			if (mainApp) {
			  mainApp.style.display = 'block';
			}
			
			// Avvia app React direttamente
			try {
			  const container = document.getElementById('app');
			  if (container) {
				const root = ReactDOM.createRoot(container);
				root.render(React.createElement(App));
				console.log('‚úÖ App calendario inizializzata con successo');
				
				setTimeout(() => {
				  showToast('üéÑ Calendario dell\'Avvento caricato! Buon divertimento!', 'success');
				}, 1000);
			  }
			} catch (error) {
			  console.error('‚ùå Errore nel rendering di React:', error);
			  showToast('Errore critico di caricamento', 'error');
			}
		  });
		</script>
		
		
		<!-- Componenti React -->
		<script type="text/babel">
		  const { useState, useEffect, useCallback, useMemo } = React;
		  const { getAuth, signInAnonymously } = firebase.auth;
		  const { getFirestore, doc, setDoc, onSnapshot, collection, query, getDocs, runTransaction, arrayUnion } = firebase.firestore;

		  // Configurazione (Max 24 giorni)
		  const DAYS = Array.from({ length: 24 }, (_, i) => i + 1); // [1, 2, ..., 24]
		  const QUIZ_DATA = [
			{
			  id: 1,
			  title: "‚≠ê Quiz Iniziale: Sulla Scia della Stella",
			  description: "Metti alla prova le tue conoscenze generali sul Natale!",
			  points: 10,
			  questions: [
				{
				  text: "Quanti Re Magi ci sono nella tradizione?",
				  options: ["Due", "Tre", "Quattro", "Cinque"],
				  answer: "Tre",
				},
				{
				  text: "In quale giorno cade l'Avvento?",
				  options: ["24 Dicembre", "1 Dicembre", "La quarta domenica prima di Natale", "Il primo Sabato di Dicembre"],
				  answer: "La quarta domenica prima di Natale",
				},
			  ],
			},
			{
			  id: 2,
			  title: "üåü Quiz Intermedio: Luci d'Inverno",
			  description: "Domande sulla cultura e le tradizioni natalizie del mondo.",
			  points: 15,
			  questions: [
				{
				  text: "Chi traina la slitta di Babbo Natale, oltre a Rudolph?",
				  options: ["Cometa e Fulmine", "Donnola e Vampa", "Dasher e Dancer", "Furia e Ballerina"],
				  answer: "Dasher e Dancer",
				},
				{
				  text: "Da dove proviene la tradizione dell'albero di Natale?",
				  options: ["Italia", "Germania", "Francia", "Inghilterra"],
				  answer: "Germania",
				},
			  ],
			},
			{
			  id: 3,
			  title: "‚ú® Quiz Avanzato: Il Mistero della Mezzanotte",
			  description: "Mettiti alla prova con curiosit√† meno note sul Natale.",
			  points: 20,
			  questions: [
				{
				  text: "In quale paese Babbo Natale √® conosciuto come P√®re No√´l?",
				  options: ["Spagna", "Francia", "Svezia", "Russia"],
				  answer: "Francia",
				},
				{
				  text: "Qual √® il nome originale inglese di 'Jingle Bells'?",
				  options: ["Christmas Bells", "One Horse Open Sleigh", "Winter Wonderland", "Sleigh Ride Song"],
				  answer: "One Horse Open Sleigh",
				},
			  ],
			},
			{
			  id: 4,
			  title: "üéÅ Quiz Finale: La Vigilia Perfetta",
			  description: "Domande veloci per chiudere in bellezza l'Avvento.",
			  points: 25,
			  questions: [
				{
				  text: "Quale animale domestico √® tipicamente associato a Grinch?",
				  options: ["Un gatto", "Un cane (Max)", "Un cervo", "Un furetto"],
				  answer: "Un cane (Max)",
				},
				{
				  text: "Quale compositore ha scritto 'Lo schiaccianoci'?",
				  options: ["Beethoven", "Mozart", "Tchaikovsky", "Bach"],
				  answer: "Tchaikovsky",
				},
			  ],
			},
		  ];
		  
		  // =================================================================================
		  // 4. Componente Modale per il Contenuto (contenuto del giorno)
		  // =================================================================================
		  
		  const ContentModal = ({ show, onClose, day, content }) => {
			if (!show) return null;
			
			return (
			  <div className="fixed inset-0 z-50 flex items-center justify-center p-4 modal-overlay" onClick={onClose}>
				<div 
				  className="bg-white rounded-xl shadow-2xl max-w-lg w-full p-6 sm:p-8 transform transition-all duration-300 scale-100 opacity-100"
				  onClick={(e) => e.stopPropagation()} // Impedisce la chiusura cliccando all'interno
				>
				  <div className="flex justify-between items-start mb-4">
					<h2 className="text-2xl font-bold text-gray-800">Giorno {day} - {content.title}</h2>
					<button 
					  onClick={onClose} 
					  className="text-gray-400 hover:text-gray-600 transition-colors p-1 rounded-full hover:bg-gray-100"
					  aria-label="Chiudi Modale"
					>
					  <svg className="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M6 18L18 6M6 6l12 12"></path></svg>
					</button>
				  </div>
				  
				  <div className="space-y-4 text-gray-700">
					<p>{content.text}</p>
					{content.image && (
					  <img 
						src={content.image} 
						alt={`Immagine per il giorno ${day}`} 
						className="w-full h-auto rounded-lg object-cover shadow-md"
						onError={(e) => e.target.src = 'https://placehold.co/400x200/cccccc/333333?text=Immagine+Non+Disponibile'}
					  />
					)}
					{content.link && (
					  <a 
						href={content.link} 
						target="_blank" 
						rel="noopener noreferrer" 
						className="text-blue-500 hover:text-blue-700 font-semibold inline-block mt-2 transition-colors"
					  >
						Scopri di pi√π qui &rarr;
					  </a>
					)}
				  </div>
				</div>
			  </div>
			);
		  };
		  
		  // =================================================================================
		  // 3. Componente Casella (Giorno)
		  // =================================================================================
		  
		  const CalendarDay = ({ day, userId, auth, db }) => {
			const [isUnlocked, setIsUnlocked] = useState(false);
			const [isModalOpen, setIsModalOpen] = useState(false);
			const [isReady, setIsReady] = useState(false);
			const [isClicked, setIsClicked] = useState(false);
			
			// Contenuto fittizio per il giorno (sar√† sovrascritto da Firestore se esiste)
			const content = {
			  title: `Sorpresa del Giorno ${day}`,
			  text: `Complimenti, hai aperto la casella del giorno ${day}! Il tuo premio √®... una manciata di felicit√† natalizia! `,
			  image: `https://placehold.co/300x200/E8D5A0/323330?text=Giorno+${day}`,
			  link: `https://it.wikipedia.org/wiki/Giorno_${day}_di_Dicembre`,
			};

			const today = useMemo(() => {
			  // In un contesto reale, usiamo la data corrente. Per i test,
			  // potremmo forzare una data (es. new Date('2024-12-15')).
			  const d = new Date();
			  return d.getDate();
			}, []);

			// Funzione di sblocco della casella
			const unlockDay = useCallback(async () => {
			  if (day > today) {
				showToast(`Non puoi aprire il giorno ${day}. Aspetta il giorno giusto!`, 'error');
				return;
			  }
			  
			  if (isUnlocked) {
				setIsModalOpen(true);
				return;
			  }
			  
			  if (!auth || !db) {
				console.error("Firebase non inizializzato per l'azione.");
				showToast('Errore: database non pronto.', 'error');
				return;
			  }
			  
			  const currentUserId = auth.currentUser?.uid || userId;
			  const userDocRef = doc(db, 'artifacts', appId, 'users', currentUserId, 'adventProgress', 'progressData');
			  
			  try {
				await runTransaction(db, async (transaction) => {
				  const userDoc = await transaction.get(userDocRef);
				  
				  if (!userDoc.exists()) {
					transaction.set(userDocRef, { unlockedDays: [day] });
				  } else {
					const data = userDoc.data();
					if (!data.unlockedDays || !data.unlockedDays.includes(day)) {
					  transaction.update(userDocRef, {
						unlockedDays: arrayUnion(day),
					  });
					}
				  }
				});
				
				// Se la transazione ha successo
				setIsUnlocked(true);
				setIsModalOpen(true);
				showToast(`üéâ Hai aperto la casella del giorno ${day}!`, 'success');
				
			  } catch (e) {
				console.error("Errore nello sblocco del giorno:", e);
				showToast('Errore nello sblocco del giorno, riprova.', 'error');
			  }
			}, [day, today, isUnlocked, auth, db, userId]);

			
			useEffect(() => {
			  let unsubscribe;
			  const currentUserId = auth?.currentUser?.uid || userId;

			  if (db && currentUserId) {
				const userDocRef = doc(db, 'artifacts', appId, 'users', currentUserId, 'adventProgress', 'progressData');
				
				unsubscribe = onSnapshot(userDocRef, (docSnap) => {
				  if (docSnap.exists()) {
					const data = docSnap.data();
					if (data.unlockedDays && data.unlockedDays.includes(day)) {
					  setIsUnlocked(true);
					}
				  }
				  setIsReady(true);
				}, (error) => {
				  console.error("Errore in onSnapshot per il giorno:", day, error);
				  setIsReady(true);
				});
			  } else {
				// Fallback immediato se Firebase non √® pronto
				setIsReady(true);
			  }
			  
			  return () => {
				if (unsubscribe) unsubscribe();
			  };
			}, [day, db, auth?.currentUser?.uid, userId]);

			// Determina gli stili CSS
			const isPast = day < today;
			const isToday = day === today;
			const isDisabled = day > today && !isPast;
			
			let cardClasses = "relative h-28 sm:h-36 md:h-48 rounded-xl shadow-lg flex flex-col items-center justify-center p-2 text-center cursor-pointer select-none card-animation transition-all duration-300 transform hover:scale-[1.02] active:scale-[0.98]";
			let textClasses = "font-bold text-2xl sm:text-3xl md:text-5xl drop-shadow-md";
			
			if (isUnlocked) {
			  // Casella aperta
			  cardClasses += " bg-yellow-400 border-4 border-yellow-600/70 text-gray-800 hover:bg-yellow-500";
			} else if (isToday) {
			  // Oggi (e non ancora aperta)
			  cardClasses += " bg-red-500 border-4 border-red-700/70 text-white animate-pulse";
			} else if (isPast) {
			  // Passato (e non ancora aperta)
			  cardClasses += " bg-green-500 border-4 border-green-700/70 text-white hover:bg-green-600";
			} else {
			  // Futuro (disabilitata)
			  cardClasses += " bg-slate-400 border-4 border-slate-500/70 text-slate-800 cursor-not-allowed hover:transform-none";
			  textClasses += " opacity-60";
			}

			if (!isReady) {
			  return <div className="h-28 sm:h-36 md:h-48 rounded-xl bg-gray-200 animate-pulse"></div>;
			}
			
			return (
			  <>
				<div 
				  className={cardClasses}
				  onClick={unlockDay}
				  style={{ 
					opacity: isDisabled ? 0.7 : 1, 
					pointerEvents: isDisabled ? 'none' : 'auto',
					backgroundImage: isUnlocked ? 'radial-gradient(circle at 50% 50%, var(--color-gold-400) 0%, var(--color-yellow-400) 100%)' : (isToday ? 'radial-gradient(circle at 50% 50%, #FF6B6B 0%, #E63946 100%)' : 'radial-gradient(circle at 50% 50%, #48BB78 0%, #38A169 100%)'),
					boxShadow: isUnlocked ? '0 0 20px rgba(255, 200, 0, 0.7)' : '0 4px 10px rgba(0, 0, 0, 0.2)'
				  }}
				>
				  <span className={textClasses}>{day}</span>
				  {isUnlocked && (
					<svg className="w-6 h-6 absolute top-2 right-2 text-white" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path fillRule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clipRule="evenodd"></path></svg>
				  )}
				  {isToday && !isUnlocked && (
					<span className="text-xs mt-1 absolute bottom-1 text-white opacity-90">APRITI!</span>
				  )}
				</div>
				
				<ContentModal 
				  show={isModalOpen} 
				  onClose={() => setIsModalOpen(false)} 
				  day={day} 
				  content={content} 
				/>
			  </>
			);
		  };
		  
		  // =================================================================================
		  // 2. Componente Sezione Quiz/Test
		  // =================================================================================
		  
		  const QuizSection = ({ quiz, userId, auth, db, onScoreUpdate }) => {
			const [currentQuestion, setCurrentQuestion] = useState(0);
			const [selectedAnswer, setSelectedAnswer] = useState(null);
			const [showResult, setShowResult] = useState(false);
			const [score, setScore] = useState(0);
			const [isQuizCompleted, setIsQuizCompleted] = useState(false);

			const currentQuiz = quiz;
			
			// Carica lo stato del quiz dall'utente
			useEffect(() => {
			  let unsubscribe;
			  const currentUserId = auth?.currentUser?.uid || userId;
			  
			  if (db && currentUserId) {
				const quizDocRef = doc(db, 'artifacts', appId, 'users', currentUserId, 'quizProgress', `quiz-${currentQuiz.id}`);
				
				unsubscribe = onSnapshot(quizDocRef, (docSnap) => {
				  if (docSnap.exists()) {
					const data = docSnap.data();
					if (data.completed) {
					  setIsQuizCompleted(true);
					  setScore(data.pointsEarned || 0);
					}
				  }
				}, (error) => {
				  console.error("Errore in onSnapshot per il quiz:", currentQuiz.id, error);
				});
			  }
			  
			  return () => {
				if (unsubscribe) unsubscribe();
			  };
			}, [currentQuiz.id, db, auth?.currentUser?.uid, userId]);

			
			const handleAnswerSelect = (option) => {
			  if (!showResult) {
				setSelectedAnswer(option);
			  }
			};

			const handleNext = () => {
			  if (showResult) {
				// Vai alla prossima domanda o mostra il punteggio finale
				if (currentQuestion < currentQuiz.questions.length - 1) {
				  setCurrentQuestion(prev => prev + 1);
				  setSelectedAnswer(null);
				  setShowResult(false);
				} else {
				  // Quiz finito, salva e mostra il risultato finale
				  completeQuiz();
				}
			  } else if (selectedAnswer) {
				// Controlla la risposta
				const question = currentQuiz.questions[currentQuestion];
				if (selectedAnswer === question.answer) {
				  setScore(prev => prev + (currentQuiz.points / currentQuiz.questions.length));
				}
				setShowResult(true);
			  } else {
				showToast('Seleziona una risposta prima di continuare.', 'info');
			  }
			};
			
			const completeQuiz = useCallback(async () => {
			  if (isQuizCompleted) return; // Gi√† completato
			  
			  const finalScore = Math.round(score);
			  
			  if (!auth || !db) {
				console.error("Firebase non inizializzato per l'azione.");
				showToast('Errore: database non pronto per salvare il quiz.', 'error');
				return;
			  }
			  
			  const currentUserId = auth.currentUser?.uid || userId;
			  const quizDocRef = doc(db, 'artifacts', appId, 'users', currentUserId, 'quizProgress', `quiz-${currentQuiz.id}`);
			  const userLeaderboardRef = doc(db, 'artifacts', appId, 'public', 'data', 'leaderboard', currentUserId);

			  try {
				// 1. Aggiorna lo stato del quiz
				await setDoc(quizDocRef, { 
				  completed: true, 
				  pointsEarned: finalScore, 
				  quizId: currentQuiz.id,
				  completedAt: new Date().toISOString()
				}, { merge: true });
				
				// 2. Aggiorna la classifica (transazione)
				await runTransaction(db, async (transaction) => {
				  const userLeaderboardDoc = await transaction.get(userLeaderboardRef);
				  const userName = auth.currentUser?.displayName || 'Utente ' + currentUserId.substring(0, 4);
				  
				  if (userLeaderboardDoc.exists()) {
					const data = userLeaderboardDoc.data();
					// Calcola il nuovo punteggio totale
					const currentTotalScore = data.totalScore || 0;
					const newTotalScore = currentTotalScore + finalScore;
					
					// Registra il quiz completato
					const completedQuizzes = data.completedQuizzes || {};
					if (!completedQuizzes[`quiz-${currentQuiz.id}`]) {
					  completedQuizzes[`quiz-${currentQuiz.id}`] = finalScore;
					  transaction.update(userLeaderboardRef, {
						totalScore: newTotalScore,
						completedQuizzes: completedQuizzes,
						lastUpdate: new Date().toISOString(),
						userName: userName
					  });
					} else {
						// Se √® gi√† registrato, non aggiornare il punteggio totale per evitare doppi conteggi
						transaction.update(userLeaderboardRef, {
						  lastUpdate: new Date().toISOString(),
						  userName: userName
						});
					}
					
				  } else {
					// Se il documento non esiste, crealo
					transaction.set(userLeaderboardRef, {
					  userId: currentUserId,
					  userName: userName,
					  totalScore: finalScore,
					  completedQuizzes: { [`quiz-${currentQuiz.id}`]: finalScore },
					  lastUpdate: new Date().toISOString()
					});
				  }
				});

				setIsQuizCompleted(true);
				setScore(finalScore); // Assicura che lo score sia quello finale
				onScoreUpdate && onScoreUpdate(); // Notifica il genitore (App)
				showToast(`üèÜ Quiz ${currentQuiz.id} completato! Hai guadagnato ${finalScore} punti!`, 'success');
				
			  } catch (e) {
				console.error("Errore nel completamento/salvataggio del quiz:", e);
				showToast('Errore nel salvataggio del quiz e punteggio.', 'error');
			  }
			}, [score, isQuizCompleted, currentQuiz, auth, db, userId, onScoreUpdate]);


			if (isQuizCompleted) {
			  return (
				<div className="p-6 md:p-8 rounded-xl quiz-section-style border-green-500 text-center">
				  <h3 className="text-xl sm:text-2xl font-extrabold text-green-700 mb-2">{currentQuiz.title}</h3>
				  <p className="text-gray-600 mb-4">‚úÖ **Hai gi√† completato questo quiz!**</p>
				  <p className="text-3xl font-bold text-green-500">Punti totali: {score}</p>
				  <p className="text-sm mt-2 text-gray-500">Grazie per aver giocato! Continua ad aprire le caselle.</p>
				</div>
			  );
			}

			const question = currentQuiz.questions[currentQuestion];
			const isLastQuestion = currentQuestion === currentQuiz.questions.length - 1;
			const isCorrect = showResult && selectedAnswer === question.answer;
			
			return (
			  <div className="p-6 md:p-8 rounded-xl quiz-section-style">
				<h3 className="text-xl sm:text-2xl font-extrabold text-slate-700 mb-2">{currentQuiz.title}</h3>
				<p className="text-gray-600 mb-4">{currentQuiz.description}</p>

				<div className="mt-6 quiz-card p-4 sm:p-6 rounded-lg shadow-inner">
				  <p className="text-sm font-medium text-blue-600 mb-1">Domanda {currentQuestion + 1} di {currentQuiz.questions.length} (Valore: {Math.round(currentQuiz.points /
